<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${contract.contractId != null} ? 'Редактирование договора' : 'Добавление договора'">Форма договора</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 10px;
            background-color: #fff;
        }
        .checkbox-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            min-height: 24px;
        }
        .form-check-input {
            width: 18px !important;
            height: 18px !important;
            margin-right: 10px;
            flex-shrink: 0;
            position: relative;
            appearance: auto !important;
            -webkit-appearance: auto !important;
        }
        .form-check-label {
            flex-grow: 1;
            cursor: pointer;
            padding-left: 5px;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        .checkbox-group::-webkit-scrollbar {
            width: 8px;
        }
        .checkbox-group::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .checkbox-group::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .checkbox-group::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Принудительное отображение стандартных чекбоксов */
        input[type="checkbox"] {
            -webkit-appearance: checkbox !important;
            -moz-appearance: checkbox !important;
            appearance: checkbox !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Альтернативное решение с кастомными чекбоксами */
        .custom-checkbox {
            display: none;
        }

        .custom-checkbox + label {
            position: relative;
            padding-left: 30px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            width: 100%;
        }

        .custom-checkbox + label:before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid #6c757d;
            border-radius: 3px;
            background: white;
        }

        .custom-checkbox:checked + label:before {
            background: #0d6efd;
            border-color: #0d6efd;
        }

        .custom-checkbox:checked + label:after {
            content: "✓";
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-file-contract" th:if="${contract.contractId == null}"></i>
            <i class="fas fa-file-contract" th:if="${contract.contractId != null}"></i>
            <span th:text="${contract.contractId != null} ? 'Редактирование договора' : 'Добавление договора'">
                Форма договора
            </span>
        </h1>
        <a th:href="@{/contracts}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Назад к списку
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <form th:action="${contract.contractId != null} ?
                                 @{/contracts/edit/{id}(id=${contract.contractId})} :
                                 @{/contracts/create}"
                  th:object="${contract}" method="post">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="contractNumber" class="form-label required-field">Номер договора</label>
                        <input type="text" class="form-control" id="contractNumber"
                               th:field="*{contractNumber}" required>
                        <div th:if="${#fields.hasErrors('contractNumber')}" class="text-danger">
                            <span th:errors="*{contractNumber}"></span>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="signDate" class="form-label required-field">Дата подписания</label>
                        <input type="date" class="form-control" id="signDate"
                               th:field="*{signDate}" required>
                        <div th:if="${#fields.hasErrors('signDate')}" class="text-danger">
                            <span th:errors="*{signDate}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Клиенты</label>
                        <div class="checkbox-group">
                            <!-- Версия 1: Стандартные чекбоксы с принудительным отображением -->
                            <div th:each="customerItem : ${customers}" class="checkbox-item">
                                <input class="form-check-input" type="checkbox"
                                       th:id="'customer_' + ${customerItem.customerId}"
                                       th:value="${customerItem.customerId}"
                                       name="selectedCustomers"
                                       th:checked="${selectedCustomerIds != null && selectedCustomerIds.contains(customerItem.customerId)}"
                                       style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                                <label class="form-check-label" th:for="'customer_' + ${customerItem.customerId}">
                                    <span th:text="${customerItem.lastName + ' ' + customerItem.firstName}"></span>
                                </label>
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('customers')}" class="error-message">
                            <span th:errors="*{customers}"></span>
                        </div>
                    </div>

                    <!-- Выбор нескольких туров -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label required-field">Туры</label>
                        <div class="checkbox-group">
                            <!-- Версия 2: Кастомные чекбоксы -->
                            <div th:each="tourItem : ${tours}" class="checkbox-item">
                                <input class="custom-checkbox" type="checkbox"
                                       th:id="'tour_' + ${tourItem.tourId}"
                                       th:value="${tourItem.tourId}"
                                       name="selectedTours"
                                       th:checked="${selectedTourIds != null && selectedTourIds.contains(tourItem.tourId)}">
                                <label th:for="'tour_' + ${tourItem.tourId}">
                                    <span th:text="${tourItem.tourName}"></span>
                                </label>
                            </div>
                        </div>
                        <div th:if="${#fields.hasErrors('tours')}" class="error-message">
                            <span th:errors="*{tours}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="discount" class="form-label">Скидка</label>
                        <select class="form-select" id="discount" th:field="*{discount}">
                            <option value="">Без скидки</option>
                            <option th:each="discountItem : ${discounts}"
                                    th:value="${discountItem.discountId}"
                                    th:text="${discountItem.discountName}"
                                    th:selected="${contract.discount != null && contract.discount.discountId == discountItem.discountId}">
                            </option>
                        </select>
                        <div th:if="${#fields.hasErrors('discount')}" class="text-danger">
                            <span th:errors="*{discount}"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="totalAmount" class="form-label required-field">Общая сумма</label>
                        <input type="number" class="form-control" id="totalAmount"
                               th:field="*{totalAmount}" step="0.01" min="0" required>
                        <div th:if="${#fields.hasErrors('totalAmount')}" class="text-danger">
                            <span th:errors="*{totalAmount}"></span>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="paidAmount" class="form-label required-field">Оплаченная сумма</label>
                        <input type="number" class="form-control" id="paidAmount"
                               th:field="*{paidAmount}" step="0.01" min="0" required>
                        <div th:if="${#fields.hasErrors('paidAmount')}" class="text-danger">
                            <span th:errors="*{paidAmount}"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="contractStatus" class="form-label required-field">Статус договора</label>
                        <select class="form-select" id="contractStatus" th:field="*{contractStatus}" required>
                            <option value="">Выберите статус</option>
                            <option th:each="statusItem : ${statuses}"
                                    th:value="${statusItem}"
                                    th:text="${statusItem == 'DRAFT' ? 'Черновик' :
                                             statusItem == 'SIGNED' ? 'Подписан' :
                                             statusItem == 'PAID' ? 'Оплачен' :
                                             statusItem == 'CANCELLED' ? 'Отменен' : statusItem}"
                                    th:selected="${contract.contractStatus == statusItem}">
                            </option>
                        </select>
                        <div th:if="${#fields.hasErrors('contractStatus')}" class="text-danger">
                            <span th:errors="*{contractStatus}"></span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        <span th:text="${contract.contractId != null} ? 'Обновить' : 'Создать'"></span>
                    </button>
                    <a th:href="@{/contracts}" class="btn btn-secondary">Отмена</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>